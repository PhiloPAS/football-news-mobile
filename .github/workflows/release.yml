name: Release
on:
  push:
    branches: [main]
permissions:
  contents: write
jobs:
  releases:
    name: Build and Release APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4
      
      - name: Get version from pubspec.yaml
        id: version
        working-directory: ./football_news
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: *//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"
      
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "17"
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
      
      - name: Disable Flutter analytics
        run: flutter config --no-analytics
      
      - name: Verify Flutter installation
        run: |
          flutter --version
          dart --version
      
      # Bersihkan folder yang tidak diperlukan
      - name: Clean up unnecessary folders
        run: |
          echo "Cleaning up unnecessary folders..."
          rm -rf football_news/form_sample || true
          echo "Cleanup completed"
      
      - name: Get packages
        working-directory: ./football_news
        run: |
          flutter clean
          flutter pub get
      
      # Analyze code dengan handling error yang baik
      - name: Analyze code
        working-directory: ./football_news
        run: |
          echo "Running Flutter analyze..."
          flutter analyze --no-fatal-infos || {
            echo "âš ï¸ Flutter analyze completed with warnings"
            echo "Continuing with build process..."
          }
        continue-on-error: true
      
      # Optional: Check code formatting
      - name: Check code formatting
        working-directory: ./football_news
        run: |
          echo "Checking code formatting..."
          dart format --set-exit-if-changed . || {
            echo "âš ï¸ Code formatting issues found"
            echo "Run 'dart format .' to fix formatting"
          }
        continue-on-error: true
      
      - name: Build APK
        working-directory: ./football_news
        run: flutter build apk --split-per-abi --release
      
      - name: Decode Keystore
        working-directory: ./football_news
        run: |
          echo "Decoding keystore..."
          echo "${{ secrets.KEY_JKS }}" | base64 -d > release-keystore.jks
          if [ -f release-keystore.jks ]; then
            echo "âœ“ Keystore decoded successfully"
          else
            echo "âœ— Failed to decode keystore"
            exit 1
          fi
      
      - name: Sign APKs
        working-directory: ./football_news
        run: |
          echo "Signing APKs..."
          SIGNED_COUNT=0
          
          for apk in build/app/outputs/flutter-apk/*.apk; do
            if [ -f "$apk" ]; then
              echo "Signing: $apk"
              
              jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
                -keystore release-keystore.jks \
                -storepass "${{ secrets.KEY_PASSWORD }}" \
                -keypass "${{ secrets.KEY_PASSWORD }}" \
                "$apk" release
              
              # Verify signature
              if jarsigner -verify -verbose -certs "$apk"; then
                echo "âœ“ Successfully signed and verified: $apk"
                SIGNED_COUNT=$((SIGNED_COUNT + 1))
              else
                echo "âœ— Failed to sign: $apk"
                exit 1
              fi
            fi
          done
          
          echo "Total APKs signed: $SIGNED_COUNT"
          
          if [ $SIGNED_COUNT -eq 0 ]; then
            echo "âœ— No APKs were signed"
            exit 1
          fi
      
      - name: Cleanup Keystore
        if: always()
        working-directory: ./football_news
        run: |
          rm -f release-keystore.jks
          echo "âœ“ Keystore cleaned up"
      
      - name: List signed APKs
        working-directory: ./football_news
        run: |
          echo "ğŸ“¦ Signed APK files:"
          ls -lh build/app/outputs/flutter-apk/*.apk
      
      - name: Get current date
        id: date
        run: echo "date=$(TZ='Asia/Jakarta' date +'%A %d-%m-%Y %T WIB')" >> $GITHUB_OUTPUT
      
      - name: Generate unique tag
        id: tag
        run: echo "tag=v${{ steps.version.outputs.version }}-$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT
      
      - name: Release APK
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: false
          artifacts: "football_news/build/app/outputs/flutter-apk/*.apk"
          body: |
            ğŸš€ **Football News v${{ steps.version.outputs.version }}**
            
            ğŸ“… Published at ${{ steps.date.outputs.date }}
            
            ## ğŸ“¦ Available APKs (Signed):
            - **arm64-v8a** - For most modern Android devices (64-bit ARM)
            - **armeabi-v7a** - For older Android devices (32-bit ARM)
            - **x86_64** - For Android emulators and x86 devices
            
            ### ğŸ“¥ Installation:
            1. Download the APK suitable for your device architecture
            2. Enable "Install from Unknown Sources" in Settings â†’ Security
            3. Install the downloaded APK
            
            ### ğŸ” Security:
            âœ“ All APKs are digitally signed and verified
            
            ---
            
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
          name: "Football News v${{ steps.version.outputs.version }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.tag.outputs.tag }}
          draft: false
          prerelease: false
